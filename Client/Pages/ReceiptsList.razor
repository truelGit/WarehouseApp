@page "/receipts"
@using WarehouseApp.Server.Models
@using WarehouseApp.Shared.Models
@inject HttpClient Http
@inject NavigationManager Navigation

<h2>Поступления</h2>

<div class="row mb-3">
    <div class="col">
        <label>Период с:</label>
        <InputDate @bind-Value="filterFrom" class="form-control" />
    </div>
    <div class="col">
        <label>Период по:</label>
        <InputDate @bind-Value="filterTo" class="form-control" />
    </div>
    <div class="col">
        <label>Номер поступления:</label>
        <MultiSelect Options="allDocumentNumbers" SelectedItems="@selectedNumbers" SelectedItemsChanged="OnSelectedNumbersChanged" />
    </div>
    <div class="col">
        <label>Ресурс:</label>
        <MultiSelect Options="resources.Select(r => r.Name).ToList()" SelectedItems="@selectedResourceNames" SelectedItemsChanged="OnSelectedResourcesChanged" />
    </div>
    <div class="col">
        <label>Единицы измерения:</label>
        <MultiSelect Options="units.Select(u => u.Name).ToList()" SelectedItems="@selectedUnitNames" SelectedItemsChanged="OnSelectedUnitsChanged" />
    </div>
</div>

<button class="btn btn-primary mb-3" @onclick="ApplyFilters">Применить фильтры</button>
<button class="btn btn-success mb-3" @onclick="CreateNewReceipt">Создать новое поступление</button>

@if (receipts == null)
{
    <p>Загрузка...</p>
}
else if (!receipts.Any())
{
    <p>Нет данных.</p>
}
else
{
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Номер</th>
                <th>Дата</th>
                <th>Ресурс</th>
                <th>Ед. изм.</th>
                <th>Количество</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var receipt in receipts)
            {
                if (receipt.Items != null && receipt.Items.Any())
                {
                    foreach (var item in receipt.Items)
                    {
                        <tr @ondblclick="() => EditReceipt(receipt.Id)">
                            <td>@receipt.Number</td>
                            <td>@receipt.Date.ToShortDateString()</td>
                            <td>@item.ResourceName</td>
                            <td>@item.UnitName</td>
                            <td>@item.Quantity</td>
                        </tr>
                    }
                }
                else
                {
                    <tr @ondblclick="() => EditReceipt(receipt.Id)">
                        <td>@receipt.Number</td>
                        <td>@receipt.Date.ToShortDateString()</td>
                        <td></td>
                        <td></td>
                        <td>0</td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

@code {
    private List<ReceiptDto>? receipts;
    private List<Resource> resources = new();
    private List<Unit> units = new();

    private DateTime? filterFrom;
    private DateTime? filterTo;
    private List<int> selectedResourceIds = new();
    private List<int> selectedUnitIds = new();
    private List<string> allDocumentNumbers = new();

    private List<string> selectedNumbers = new();
    private List<string> selectedResourceNames = new();
    private List<string> selectedUnitNames = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadResourcesAndUnits();
        await LoadReceipts();
    }

    private async Task LoadReceipts()
    {
        receipts = await Http.GetFromJsonAsync<List<ReceiptDto>>("api/receipts");
        if (receipts != null)
        {
            allDocumentNumbers = receipts
                .Select(r => r.Number)
                .Distinct()
                .OrderBy(n => n)
                .ToList();
        }
    }

    private async Task LoadResourcesAndUnits()
    {
        resources = await Http.GetFromJsonAsync<List<Resource>>("api/resources") ?? new List<Resource>();
        units = await Http.GetFromJsonAsync<List<Unit>>("api/units") ?? new List<Unit>();
    }

    private async Task ApplyFilters()
    {
        var queryParams = new List<string>();

        if (filterFrom.HasValue)
            queryParams.Add($"from={Uri.EscapeDataString(filterFrom.Value.ToString("yyyy-MM-dd"))}");
        if (filterTo.HasValue)
            queryParams.Add($"to={Uri.EscapeDataString(filterTo.Value.ToString("yyyy-MM-dd"))}");

        foreach (var num in selectedNumbers)
            queryParams.Add($"numbers={Uri.EscapeDataString(num)}");

        var selectedResourceIds = resources
            .Where(r => selectedResourceNames.Contains(r.Name))
            .Select(r => r.Id)
            .ToList();

        var selectedUnitIds = units
            .Where(u => selectedUnitNames.Contains(u.Name))
            .Select(u => u.Id)
            .ToList();

        foreach (var id in selectedResourceIds)
            queryParams.Add($"resourceIds={id}");

        foreach (var id in selectedUnitIds)
            queryParams.Add($"unitIds={id}");

        var query = string.Join("&", queryParams);

        receipts = await Http.GetFromJsonAsync<List<ReceiptDto>>($"api/receipts/filtered?{query}");
    }


    private void EditReceipt(int id)
    {
        Navigation.NavigateTo($"/receipts/edit/{id}");
    }

    private void CreateNewReceipt()
    {
        Navigation.NavigateTo($"/receipts/create");
    }

    private void OnSelectedNumbersChanged(List<string> selected)
    {
        selectedNumbers = selected;
    }

    private void OnSelectedResourcesChanged(List<string> selected)
    {
        selectedResourceNames = selected;
    }

    private void OnSelectedUnitsChanged(List<string> selected)
    {
        selectedUnitNames = selected;
    }
}
